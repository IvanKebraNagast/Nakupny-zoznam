<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Nákupný Zoznam</title>

  <!-- PWA -->
  <link rel="manifest" href="/Nakupny-zoznam/manifest.webmanifest">
  <meta name="theme-color" content="#10b981">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="Nákupný zoznam">
  <!-- (Keď pridáš ikonky, odkomentuj a nechaj cesty) -->
  <!-- <link rel="apple-touch-icon" href="/Nakupny-zoznam/icons/icon-180.png"> -->

  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body{
      font-family:'Inter',sans-serif;background-color:#f3f4f6;
      display:flex;justify-content:center;align-items:flex-start;min-height:100vh;padding:2rem 1rem;
    }
    .dragging{opacity:.5;box-shadow:0 4px 12px rgba(0,0,0,.15);transform:scale(1.02)}
    .app-container{max-width:420px;width:100%}
    @media print{
      .no-print{display:none!important}
      body{background-color:#fff}
      .print-area{box-shadow:none;border-top:none;padding:0}
      .receipt-image-print{max-width:100%;height:auto;margin-top:1.5rem}
    }
  </style>
</head>
<body class="bg-gray-100 p-8">

  <!-- Hlavný kontajner -->
  <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl app-container border-t-4 border-emerald-500 print-area">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Môj Nákupný Zoznam</h1>

    <!-- Prepínanie pohľadov -->
    <div class="flex justify-center gap-2 mb-6 no-print">
      <button id="showCurrentListBtn" class="flex-grow bg-emerald-500 text-white p-3 rounded-xl font-semibold shadow-md hover:bg-emerald-600 transition duration-200 active:scale-95">Aktuálny Zoznam</button>
      <button id="showHistoryBtn" class="flex-grow bg-slate-200 text-gray-700 p-3 rounded-xl font-semibold shadow-md hover:bg-slate-300 transition duration-200 active:scale-95">História Nákupov</button>
    </div>

    <!-- Aktuálny zoznam -->
    <div id="currentListSection">
      <form id="addItemForm" class="flex flex-col sm:flex-row items-center gap-2 mb-6 no-print">
        <input type="text" id="itemInput" placeholder="Pridať položku..." class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:border-emerald-500 transition duration-200">
        <button type="submit" class="w-full sm:w-auto bg-emerald-500 text-white p-3 rounded-xl font-semibold shadow-md hover:bg-emerald-600 transition duration-200 active:scale-95">Pridať</button>
      </form>

      <ul id="shoppingList" class="space-y-3"></ul>

      <div id="totalSum" class="mt-6 text-right font-bold text-xl text-gray-800">Celková suma: €0.00</div>

      <div class="flex flex-col md:flex-row justify-between mt-6 space-y-2 md:space-y-0 md:space-x-2 no-print">
        <button id="clearCompletedBtn" class="flex-grow bg-slate-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-slate-300 transition duration-200 active:scale-95">Vymazať dokončené</button>
        <button id="clearAllBtn" class="flex-grow bg-rose-500 text-white py-3 rounded-xl font-semibold hover:bg-rose-600 transition duration-200 active:scale-95">Vymazať všetko</button>
      </div>
      <div class="flex justify-center mt-4 no-print">
        <button id="saveListBtn" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-semibold hover:bg-indigo-600 transition duration-200 active:scale-95">Uložiť a Finalizovať Zoznam</button>
      </div>
    </div>

    <!-- História -->
    <div id="historySection" class="hidden">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">História nákupov</h2>
      <ul id="savedLists" class="space-y-4"></ul>
    </div>

    <div class="mt-6 p-4 rounded-xl shadow-inner bg-emerald-50 border border-emerald-200 text-emerald-800 text-center text-sm no-print">
      Vytvoril: IvanKebraNagast
    </div>
  </div>

  <!-- Modal cena -->
  <div id="priceModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Zadať cenu</h3>
      <input type="number" id="modalPriceInput" placeholder="Cena (€)" step="0.01" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:border-emerald-500 transition duration-200 mb-4">
      <div class="flex justify-center gap-2">
        <button id="savePriceBtn" class="flex-grow bg-emerald-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-emerald-600 transition duration-200">Uložiť</button>
        <button id="cancelPriceBtn" class="flex-grow bg-slate-200 text-gray-700 py-2 px-4 rounded-xl font-semibold hover:bg-slate-300 transition duration-200">Zrušiť</button>
      </div>
    </div>
  </div>

  <!-- Modal bloček -->
  <div id="receiptModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
      <h3 class="text-xl font-semibold text-gray-800 mb-4">Detaily bločku</h3>
      <div class="flex flex-col items-center mb-4">
        <label class="block text-gray-700 font-semibold mb-2">Nahrať obrázok:</label>
        <input type="file" id="receiptImageInput" accept="image/*" class="w-full p-2 rounded-xl border border-gray-300 text-gray-700">
      </div>
      <label for="receiptNotesInput" class="block text-gray-700 font-semibold mb-2 text-left">Poznámky k bločku:</label>
      <textarea id="receiptNotesInput" rows="3" placeholder="Voliteľné poznámky..." class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:border-emerald-500 transition duration-200 mb-4"></textarea>
      <div class="flex justify-center gap-2">
        <button id="confirmSaveListBtn" class="flex-grow bg-emerald-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-emerald-600 transition duration-200">Uložiť a Finalizovať</button>
        <button id="cancelSaveListBtn" class="flex-grow bg-slate-200 text-gray-700 py-2 px-4 rounded-xl font-semibold hover:bg-slate-300 transition duration-200">Zrušiť</button>
      </div>
    </div>
  </div>

  <script>
  // ====== TVOJA LOGIKA (bez zmien) ======
  const addItemForm=document.getElementById('addItemForm');
  const itemInput=document.getElementById('itemInput');
  const shoppingList=document.getElementById('shoppingList');
  const totalSum=document.getElementById('totalSum');
  const clearCompletedBtn=document.getElementById('clearCompletedBtn');
  const clearAllBtn=document.getElementById('clearAllBtn');
  const saveListBtn=document.getElementById('saveListBtn');
  const showCurrentListBtn=document.getElementById('showCurrentListBtn');
  const showHistoryBtn=document.getElementById('showHistoryBtn');
  const currentListSection=document.getElementById('currentListSection');
  const historySection=document.getElementById('historySection');
  const savedListsContainer=document.getElementById('savedLists');

  const priceModal=document.getElementById('priceModal');
  const modalPriceInput=document.getElementById('modalPriceInput');
  const savePriceBtn=document.getElementById('savePriceBtn');
  const cancelPriceBtn=document.getElementById('cancelPriceBtn');

  const receiptModal=document.getElementById('receiptModal');
  const receiptImageInput=document.getElementById('receiptImageInput');
  const receiptNotesInput=document.getElementById('receiptNotesInput');
  const confirmSaveListBtn=document.getElementById('confirmSaveListBtn');
  const cancelSaveListBtn=document.getElementById('cancelSaveListBtn');

  const STORAGE_KEY_ITEMS='currentShoppingList';
  const STORAGE_KEY_HISTORY='shoppingHistory';

  let currentItems=[]; let savedHistory=[]; let dragSrcEl=null; let itemIndexToEdit=null; let receiptImageBase64=null;

  function loadData(){
    try{
      const i=localStorage.getItem(STORAGE_KEY_ITEMS); if(i) currentItems=JSON.parse(i);
      const h=localStorage.getItem(STORAGE_KEY_HISTORY); if(h) savedHistory=JSON.parse(h);
    }catch(e){ currentItems=[]; savedHistory=[]; }
  }
  function saveData(){
    try{
      localStorage.setItem(STORAGE_KEY_ITEMS', JSON.stringify(currentItems));
      localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(savedHistory));
    }catch(e){}
  }

  function calculateTotal(){
    const total=currentItems.reduce((s,it)=> s + (it.price? (isNaN(parseFloat(it.price))?0:parseFloat(it.price)) : 0), 0);
    totalSum.textContent=`Celková suma: €${total.toFixed(2)}`;
  }

  function renderCurrentList(){
    shoppingList.innerHTML='';
    currentItems.forEach((item,index)=>{
      const li=document.createElement('li');
      li.className=`flex items-center justify-between p-4 rounded-xl shadow-sm cursor-grab transition-all duration-200 ease-in-out border ${item.completed?'bg-emerald-100 border-emerald-300':'bg-gray-50 border-gray-200'}`;
      li.setAttribute('draggable','true'); li.setAttribute('data-index',index);

      const details=document.createElement('div'); details.className='flex-grow flex items-center';

      const check=document.createElement('button');
      check.className=`w-6 h-6 rounded-full flex items-center justify-center border-2 transition duration-200 mr-4 ${item.completed?'bg-emerald-500 border-emerald-500 text-white':'bg-white border-gray-400'}`;
      if(item.completed){ check.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>'; }
      check.addEventListener('click',e=>{e.stopPropagation(); toggleItemCompleted(index);});

      const txt=document.createElement('span'); txt.textContent=item.text; txt.className=`flex-grow ${item.completed?'text-gray-500 line-through':'text-gray-800'}`;

      const price=document.createElement('span'); price.textContent=item.price?` (€${parseFloat(item.price).toFixed(2)})`:''; price.className=`text-sm text-gray-500 ml-1 ${item.completed?'line-through':''}`;

      const btns=document.createElement('div'); btns.className='flex items-center space-x-2';

      const addPrice=document.createElement('button'); addPrice.innerHTML=item.price?'Upraviť cenu':'Pridať cenu';
      addPrice.className='bg-slate-200 text-gray-700 text-xs py-1 px-2 rounded-xl font-semibold hover:bg-slate-300 transition duration-200';
      addPrice.addEventListener('click',e=>{e.stopPropagation(); showPriceModal(index);});

      const del=document.createElement('button');
      del.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-red-500 transition" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"/></svg>';
      del.className='p-1 rounded-full hover:bg-gray-200 transition'; del.addEventListener('click',e=>{e.stopPropagation(); deleteItem(index);});

      details.appendChild(txt); details.appendChild(price);
      btns.appendChild(addPrice); btns.appendChild(del);
      li.appendChild(check); li.appendChild(details); li.appendChild(btns);
      shoppingList.appendChild(li);
    });
    calculateTotal(); addDragAndDropListeners();
  }

  function renderHistory(){
    savedListsContainer.innerHTML='';
    if(savedHistory.length===0){ savedListsContainer.innerHTML='<p class="text-center text-gray-500">Žiadne uložené nákupy.</p>'; return; }
    savedHistory.forEach((list,index)=>{
      const li=document.createElement('li'); li.className='p-4 rounded-xl shadow-sm bg-gray-50 border border-gray-200 transition duration-200';
      const img = list.receiptImage?`<div class="mt-4"><img src="${list.receiptImage}" alt="Obrázok bločku" class="w-full h-auto rounded-md border border-gray-300"></div>`:'';
      li.innerHTML=`
        <div class="flex justify-between items-center">
          <span class="text-lg font-semibold text-gray-800">Nákup z ${list.date}</span>
          <span class="text-sm font-bold text-emerald-600">€${list.total.toFixed(2)}</span>
        </div>
        <ul class="list-disc list-inside mt-2 text-gray-700 text-sm">
          ${list.items.map(it=>`<li class="${it.completed?'line-through text-gray-500':''}">${it.text} ${it.price?`(${parseFloat(it.price).toFixed(2)} €)`:''}</li>`).join('')}
        </ul>
        ${img}
        ${list.receiptNotes?`<p class="mt-2 text-sm text-gray-600 border-t pt-2 border-gray-200"><strong>Poznámka k bločku:</strong><br>${list.receiptNotes}</p>`:''}
        <div class="flex justify-end mt-4 no-print">
          <button onclick="printList(${index})" class="bg-indigo-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-indigo-600 transition duration-200">Tlačiť</button>
          <button onclick="deleteSavedList(${index})" class="ml-2 bg-rose-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-rose-600 transition duration-200">Vymazať</button>
        </div>`;
      savedListsContainer.appendChild(li);
    });
  }

  function toggleView(view){
    if(view==='current'){
      currentListSection.classList.remove('hidden'); historySection.classList.add('hidden');
      showCurrentListBtn.classList.add('bg-emerald-500','text-white'); showCurrentListBtn.classList.remove('bg-slate-200','text-gray-700');
      showHistoryBtn.classList.remove('bg-emerald-500','text-white'); showHistoryBtn.classList.add('bg-slate-200','text-gray-700');
    }else{
      currentListSection.classList.add('hidden'); historySection.classList.remove('hidden');
      showHistoryBtn.classList.add('bg-emerald-500','text-white'); showHistoryBtn.classList.remove('bg-slate-200','text-gray-700');
      showCurrentListBtn.classList.remove('bg-emerald-500','text-white'); showCurrentListBtn.classList.add('bg-slate-200','text-gray-700');
      renderHistory();
    }
  }

  function addItem(text){
    if(text.trim()==='') return;
    currentItems.push({text:text.trim(),completed:false,price:null});
    itemInput.value=''; saveData(); renderCurrentList();
  }

  function showPriceModal(i){ itemIndexToEdit=i; modalPriceInput.value=currentItems[i].price!==null?currentItems[i].price:''; priceModal.classList.remove('hidden'); }
  function savePrice(){ if(itemIndexToEdit!==null){ const v=parseFloat(modalPriceInput.value); currentItems[itemIndexToEdit].price=isNaN(v)?null:v; saveData(); renderCurrentList(); hidePriceModal(); } }
  function hidePriceModal(){ priceModal.classList.add('hidden'); itemIndexToEdit=null; }

  function showReceiptModal(){
    if(currentItems.length===0){
      const m=document.createElement('div');
      m.className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4";
      m.innerHTML=`<div class="bg-white p-6 rounded-lg shadow-xl text-center"><p class="text-lg font-semibold text-gray-800 mb-4">Zoznam je prázdny. Nemôžete uložiť prázdny zoznam.</p><button class="bg-emerald-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-emerald-600 transition duration-200" onclick="this.parentElement.parentElement.remove()">Zavrieť</button></div>`;
      document.body.appendChild(m); return;
    }
    receiptModal.classList.remove('hidden');
  }

  function toggleItemCompleted(i){
    if(i>=0 && i<currentItems.length){
      currentItems[i].completed=!currentItems[i].completed;
      const moved=currentItems.splice(i,1)[0];
      if(moved.completed){ currentItems.push(moved);} else { currentItems.unshift(moved); }
      saveData(); renderCurrentList();
    }
  }
  function deleteItem(i){ if(i>=0 && i<currentItems.length){ currentItems.splice(i,1); saveData(); renderCurrentList(); } }
  function clearCompleted(){ currentItems=currentItems.filter(it=>!it.completed); saveData(); renderCurrentList(); }
  function clearAll(){ currentItems=[]; saveData(); renderCurrentList(); }

  function saveList(){
    const notes=receiptNotesInput.value||null;
    const total=currentItems.reduce((s,it)=> s+(it.price||0),0);
    savedHistory.unshift({ date:new Date().toLocaleDateString('sk-SK'), total, receiptNotes:notes, receiptImage:receiptImageBase64, items:currentItems });
    currentItems=[]; receiptImageBase64=null; receiptNotesInput.value=''; receiptImageInput.value='';
    saveData(); renderCurrentList(); toggleView('history'); receiptModal.classList.add('hidden');
  }

  function deleteSavedList(i){
    const modal=document.createElement('div'); modal.className="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4";
    const content=document.createElement('div'); content.className="bg-white p-6 rounded-lg shadow-xl text-center";
    content.innerHTML=`<p class="text-lg font-semibold text-gray-800 mb-4">Naozaj chcete vymazať tento nákup?</p>
      <div class="flex justify-center gap-2">
        <button id="confirmDeleteBtn" class="bg-rose-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-rose-600 transition duration-200">Áno</button>
        <button id="cancelDeleteBtn" class="bg-slate-200 text-gray-700 py-2 px-4 rounded-xl font-semibold hover:bg-slate-300 transition duration-200">Nie</button>
      </div>`;
    modal.appendChild(content); document.body.appendChild(modal);
    document.getElementById('confirmDeleteBtn').addEventListener('click',()=>{ confirmDelete(i); modal.remove(); });
    document.getElementById('cancelDeleteBtn').addEventListener('click',()=>modal.remove());
  }
  window.confirmDelete=(i)=>{ savedHistory.splice(i,1); saveData(); renderHistory(); }

  function printList(i){
    const list=savedHistory[i];
    const img=list.receiptImage?`<div class="mt-6 receipt-image-print"><h2 class="text-2xl font-bold text-gray-800 mb-4">Obrázok bločku</h2><img src="${list.receiptImage}" alt="Obrázok bločku" style="max-width:100%;height:auto;border:1px solid #e5e7eb;border-radius:.5rem;"></div>`:'';
    const html=`<div class="p-8">
      <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Nákupný Zoznam</h1>
      <p class="text-center text-gray-600 mb-4"><strong>Dátum:</strong> ${list.date}</p>
      <ul class="space-y-2">
        ${list.items.map(it=>`<li class="flex justify-between items-center text-lg"><span class="${it.completed?'line-through text-gray-500':''}">${it.text}</span><span class="font-semibold text-gray-800">${it.price?`€${parseFloat(it.price).toFixed(2)}`:''}</span></li>`).join('')}
      </ul>
      <div class="mt-6 text-right font-bold text-2xl text-gray-800 border-t pt-4">Celková suma: €${list.total.toFixed(2)}</div>
      ${img}
      ${list.receiptNotes?`<div class="mt-6 border-t pt-4"><p class="text-sm"><strong>Poznámka k bločku:</strong><br>${list.receiptNotes}</p></div>`:''}
      <div class="no-print mt-6 text-center"><button onclick="window.close()" class="bg-indigo-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-indigo-600 transition duration-200">Späť do aplikácie</button></div>
    </div>`;
    const w=window.open('','','width=800,height=600');
    w.document.write('<html><head><title>Tlač nákupu</title><style>@import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");body{font-family:Inter,sans-serif}</style><style>@media print{.no-print{display:none}}</style></head><body>'+html+'</body></html>');
    w.document.close(); w.focus(); setTimeout(()=>{ w.print(); w.onafterprint=()=>w.close(); },500);
  }

  function addDragAndDropListeners(){
    const items=document.querySelectorAll('#shoppingList li');
    items.forEach(it=>{
      it.addEventListener('dragstart',handleDragStart);
      it.addEventListener('dragover',handleDragOver);
      it.addEventListener('dragleave',handleDragLeave);
      it.addEventListener('drop',handleDrop);
      it.addEventListener('dragend',handleDragEnd);
    });
  }
  function handleDragStart(e){ dragSrcEl=this; e.dataTransfer.effectAllowed='move'; e.dataTransfer.setData('text/html',this.innerHTML); this.classList.add('dragging'); }
  function handleDragOver(e){ e.preventDefault(); e.dataTransfer.dropEffect='move'; this.classList.add('bg-gray-200'); }
  function handleDragLeave(){ this.classList.remove('bg-gray-200'); }
  function handleDrop(e){ e.stopPropagation(); if(dragSrcEl!==this){ const di=parseInt(dragSrcEl.getAttribute('data-index')); const ti=parseInt(this.getAttribute('data-index')); const [r]=currentItems.splice(di,1); currentItems.splice(ti,0,r); saveData(); renderCurrentList(); } return false; }
  function handleDragEnd(){ document.querySelectorAll('#shoppingList li').forEach(i=>i.classList.remove('dragging','bg-gray-200')); }

  function setupEventListeners(){
    addItemForm.addEventListener('submit',e=>{e.preventDefault(); addItem(itemInput.value);});
    clearCompletedBtn.addEventListener('click',clearCompleted);
    clearAllBtn.addEventListener('click',clearAll);
    saveListBtn.addEventListener('click',showReceiptModal);
    confirmSaveListBtn.addEventListener('click',saveList);
    cancelSaveListBtn.addEventListener('click',()=>receiptModal.classList.add('hidden'));
    receiptImageInput.addEventListener('change',e=>{
      const f=e.target.files[0]; if(f){ const r=new FileReader(); r.onloadend=()=>receiptImageBase64=r.result; r.readAsDataURL(f); }
    });
    showCurrentListBtn.addEventListener('click',()=>toggleView('current'));
    showHistoryBtn.addEventListener('click',()=>toggleView('history'));
    savePriceBtn.addEventListener('click',savePrice);
    cancelPriceBtn.addEventListener('click',hidePriceModal);
  }

  window.onload=()=>{ loadData(); renderCurrentList(); setupEventListeners(); };

  // ====== REGISTRÁCIA SW (PWA pre iOS) ======
  if('serviceWorker' in navigator){
    window.addEventListener('load', ()=>{
      navigator.serviceWorker.register('/Nakupny-zoznam/sw.js').catch(()=>{});
    });
  }
  </script>
</body>
</html>
