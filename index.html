<!DOCTYPE html>
<html lang="sk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nákupný Zoznam</title>

    <!-- Manifest pre Android/Chrome -->
    <link rel="manifest" href="/Nakupny-zoznam/manifest.webmanifest">
    <!-- Ikonka pre iPhone/iPad (Safari) -->
    <link rel="apple-touch-icon" href="/Nakupny-zoznam/icon.png">


    <!-- Farba horného panela v mobile -->
    <meta name="theme-color" content="#10b981">
    <!-- iOS PWA nastavenia -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Nákupný zoznam">

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
        }

        .dragging {
            opacity: 0.5;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: scale(1.02);
        }

        /* Nové pravidlo pre obmedzenie šírky na väčších obrazovkách */
        .app-container {
            max-width: 420px; /* Typická šírka pre mobilné zariadenia */
            width: 100%;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background-color: #fff;
            }
            .print-area {
                box-shadow: none;
                border-top: none;
                padding: 0;
            }
            .receipt-image-print {
                max-width: 100%;
                height: auto;
                margin-top: 1.5rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <!-- Hlavný kontajner aplikácie s obmedzenou šírkou -->
    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl app-container border-t-4 border-emerald-500 print-area">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Môj Nákupný Zoznam</h1>

        <!-- Navigačné tlačidlá pre prepínanie zobrazenia -->
        <div class="flex justify-center gap-2 mb-6 no-print">
            <button id="showCurrentListBtn" class="flex-grow bg-emerald-500 text-white p-3 rounded-xl font-semibold shadow-md hover:bg-emerald-600 transition duration-200 active:scale-95">Aktuálny Zoznam</button>
            <button id="showHistoryBtn" class="flex-grow bg-slate-200 text-gray-700 p-3 rounded-xl font-semibold shadow-md hover:bg-slate-300 transition duration-200 active:scale-95">História Nákupov</button>
        </div>

        <!-- Sekcia aktuálneho nákupného zoznamu -->
        <div id="currentListSection">
            <!-- Formulár pre pridanie nových položiek -->
            <form id="addItemForm" class="flex flex-col sm:flex-row items-center gap-2 mb-6 no-print">
                <input type="text" id="itemInput" placeholder="Pridať položku..." class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:border-emerald-500 transition duration-200">
                <button type="submit" class="w-full sm:w-auto bg-emerald-500 text-white p-3 rounded-xl font-semibold shadow-md hover:bg-emerald-600 transition duration-200 active:scale-95">
                    Pridať
                </button>
            </form>

            <!-- Zoznam položiek s funkciou presunu -->
            <ul id="shoppingList" class="space-y-3">
                <!-- Položky budú pridané pomocou JavaScriptu -->
            </ul>

            <!-- Zobrazenie celkovej sumy -->
            <div id="totalSum" class="mt-6 text-right font-bold text-xl text-gray-800">
                Celková suma: €0.00
            </div>

            <!-- Akčné tlačidlá (bez tlače) -->
            <div class="flex flex-col md:flex-row justify-between mt-6 space-y-2 md:space-y-0 md:space-x-2 no-print">
                <button id="clearCompletedBtn" class="flex-grow bg-slate-200 text-gray-700 py-3 rounded-xl font-semibold hover:bg-slate-300 transition duration-200 active:scale-95">Vymazať dokončené</button>
                <button id="clearAllBtn" class="flex-grow bg-rose-500 text-white py-3 rounded-xl font-semibold hover:bg-rose-600 transition duration-200 active:scale-95">Vymazať všetko</button>
            </div>
            <div class="flex justify-center mt-4 no-print">
                <button id="saveListBtn" class="w-full bg-indigo-500 text-white py-3 rounded-xl font-semibold hover:bg-indigo-600 transition duration-200 active:scale-95">Uložiť a Finalizovať Zoznam</button>
            </div>
        </div>

        <!-- Sekcia histórie nákupov (predvolene skrytá) -->
        <div id="historySection" class="hidden">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">História nákupov</h2>
            <ul id="savedLists" class="space-y-4">
                <!-- Uložené zoznamy budú pridané tu -->
            </ul>
        </div>

        <!-- Text s atribútom, teraz v zelenom rámčeku -->
        <div class="mt-6 p-4 rounded-xl shadow-inner bg-emerald-50 border border-emerald-200 text-emerald-800 text-center text-sm no-print">
            Vytvoril: IvanKebraNagast
        </div>
    </div>

    <!-- Modal pre pridanie/úpravu ceny -->
    <div id="priceModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Zadať cenu</h3>
            <!-- Zmena z type="number" na type="text" pre podporu matematických operácií -->
            <input type="text" id="modalPriceInput" placeholder="Cena (napr. 1.19*2+1.09)" class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:border-emerald-500 transition duration-200 mb-4">
            <div id="priceError" class="text-sm text-red-500 mb-2 hidden">Nesprávny formát. Použi iba čísla a operátory (+, -, *, /).</div>
            <div class="flex justify-center gap-2">
                <button id="savePriceBtn" class="flex-grow bg-emerald-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-emerald-600 transition duration-200">Uložiť</button>
                <button id="cancelPriceBtn" class="flex-grow bg-slate-200 text-gray-700 py-2 px-4 rounded-xl font-semibold hover:bg-slate-300 transition duration-200">Zrušiť</button>
            </div>
        </div>
    </div>

    <!-- Modal pre pridanie detailov bločku -->
    <div id="receiptModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center w-full max-w-sm">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Detaily bločku</h3>
            <div class="flex flex-col items-center mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Nahrať obrázok:</label>
                <input type="file" id="receiptImageInput" accept="image/*" class="w-full p-2 rounded-xl border border-gray-300 text-gray-700">
            </div>
            <label for="receiptNotesInput" class="block text-gray-700 font-semibold mb-2 text-left">Poznámky k bločku:</label>
            <textarea id="receiptNotesInput" rows="3" placeholder="Voliteľné poznámky..." class="w-full p-3 rounded-xl border border-gray-300 focus:outline-none focus:border-emerald-500 transition duration-200 mb-4"></textarea>
            <div class="flex justify-center gap-2">
                <button id="confirmSaveListBtn" class="flex-grow bg-emerald-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-emerald-600 transition duration-200">Uložiť a Finalizovať</button>
                <button id="cancelSaveListBtn" class="flex-grow bg-slate-200 text-gray-700 py-2 px-4 rounded-xl font-semibold hover:bg-slate-300 transition duration-200">Zrušiť</button>
            </div>
        </div>
    </div>

    <script>
        // DOM elementy
        const addItemForm = document.getElementById('addItemForm');
        const itemInput = document.getElementById('itemInput');
        const shoppingList = document.getElementById('shoppingList');
        const totalSum = document.getElementById('totalSum');
        const clearCompletedBtn = document.getElementById('clearCompletedBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const saveListBtn = document.getElementById('saveListBtn');
        const showCurrentListBtn = document.getElementById('showCurrentListBtn');
        const showHistoryBtn = document.getElementById('showHistoryBtn');
        const currentListSection = document.getElementById('currentListSection');
        const historySection = document.getElementById('historySection');
        const savedListsContainer = document.getElementById('savedLists');

        const priceModal = document.getElementById('priceModal');
        const modalPriceInput = document.getElementById('modalPriceInput');
        const savePriceBtn = document.getElementById('savePriceBtn');
        const cancelPriceBtn = document.getElementById('cancelPriceBtn');
        const priceError = document.getElementById('priceError');

        const receiptModal = document.getElementById('receiptModal');
        const receiptImageInput = document.getElementById('receiptImageInput');
        const receiptNotesInput = document.getElementById('receiptNotesInput');
        const confirmSaveListBtn = document.getElementById('confirmSaveListBtn');
        const cancelSaveListBtn = document.getElementById('cancelSaveListBtn');

        // Kľúče pre úložisko
        const STORAGE_KEY_ITEMS = 'currentShoppingList';
        const STORAGE_KEY_HISTORY = 'shoppingHistory';

        let currentItems = [];
        let savedHistory = [];
        let dragSrcEl = null;
        let itemIndexToEdit = null;
        let receiptImageBase64 = null;
        
        /**
         * Načíta dáta z localStorage.
         */
        function loadData() {
            try {
                const storedItems = localStorage.getItem(STORAGE_KEY_ITEMS);
                if (storedItems) {
                    currentItems = JSON.parse(storedItems);
                }
                const storedHistory = localStorage.getItem(STORAGE_KEY_HISTORY);
                if (storedHistory) {
                    savedHistory = JSON.parse(storedHistory);
                }
            } catch (e) {
                console.error("Failed to load data from localStorage", e);
                currentItems = [];
                savedHistory = [];
            }
        }

        /**
         * Uloží aktuálne dáta do localStorage.
         */
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY_ITEMS, JSON.stringify(currentItems));
                localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(savedHistory));
            } catch (e) {
                console.error("Failed to save data to localStorage", e);
            }
        }

        /**
         * Vypočíta a zobrazí celkovú sumu všetkých položiek, ktoré majú priradenú cenu.
         */
        function calculateTotal() {
            const total = currentItems.reduce((sum, item) => {
                const price = parseFloat(item.price);
                return sum + (isNaN(price) ? 0 : price);
            }, 0);
            totalSum.textContent = `Celková suma: €${total.toFixed(2)}`;
        }
        
        /**
         * Vykreslí aktuálny nákupný zoznam.
         */
        function renderCurrentList() {
            shoppingList.innerHTML = '';
            
            currentItems.forEach((item, index) => {
                const listItem = document.createElement('li');
                listItem.className = `flex items-center justify-between p-4 rounded-xl shadow-sm cursor-grab transition-all duration-200 ease-in-out border ${item.completed ? 'bg-emerald-100 border-emerald-300' : 'bg-gray-50 border-gray-200'}`;
                listItem.setAttribute('draggable', 'true');
                listItem.setAttribute('data-index', index);
                
                const itemDetails = document.createElement('div');
                itemDetails.className = 'flex-grow flex items-center';

                const checkButton = document.createElement('button');
                checkButton.className = `w-6 h-6 rounded-full flex items-center justify-center border-2 transition duration-200 mr-4 ${item.completed ? 'bg-emerald-500 border-emerald-500 text-white' : 'bg-white border-gray-400'}`;
                if (item.completed) {
                    checkButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
                }
                checkButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleItemCompleted(index);
                });
                
                const itemText = document.createElement('span');
                itemText.textContent = item.text;
                itemText.className = `flex-grow ${item.completed ? 'text-gray-500 line-through' : 'text-gray-800'}`;
                
                const itemPrice = document.createElement('span');
                itemPrice.textContent = item.price ? ` (€${parseFloat(item.price).toFixed(2)})` : '';
                itemPrice.className = `text-sm text-gray-500 ml-1 ${item.completed ? 'line-through' : ''}`;
                
                const buttonsContainer = document.createElement('div');
                buttonsContainer.className = 'flex items-center space-x-2';
                
                const addPriceButton = document.createElement('button');
                addPriceButton.innerHTML = item.price ? `Upraviť cenu` : `Pridať cenu`;
                addPriceButton.className = 'bg-slate-200 text-gray-700 text-xs py-1 px-2 rounded-xl font-semibold hover:bg-slate-300 transition duration-200';
                addPriceButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showPriceModal(index);
                });
                
                const deleteButton = document.createElement('button');
                deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 hover:text-red-500 transition" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" /></svg>`;
                deleteButton.className = 'p-1 rounded-full hover:bg-gray-200 transition';
                deleteButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteItem(index);
                });

                itemDetails.appendChild(itemText);
                itemDetails.appendChild(itemPrice);
                buttonsContainer.appendChild(addPriceButton);
                buttonsContainer.appendChild(deleteButton);
                
                listItem.appendChild(checkButton);
                listItem.appendChild(itemDetails);
                listItem.appendChild(buttonsContainer);
                shoppingList.appendChild(listItem);
            });
            calculateTotal();
            addDragAndDropListeners();
        }

        /**
         * Vykreslí históriu nákupov.
         */
        function renderHistory() {
            savedListsContainer.innerHTML = '';
            if (savedHistory.length === 0) {
                savedListsContainer.innerHTML = `<p class="text-center text-gray-500">Žiadne uložené nákupy.</p>`;
                return;
            }
            savedHistory.forEach((list, index) => {
                const listItem = document.createElement('li');
                listItem.className = `p-4 rounded-xl shadow-sm bg-gray-50 border border-gray-200 transition duration-200`;
                
                let receiptImageHtml = '';
                if (list.receiptImage) {
                    receiptImageHtml = `<div class="mt-4"><img src="${list.receiptImage}" alt="Obrázok bločku" class="w-full h-auto rounded-md border border-gray-300"></div>`;
                }

                listItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span class="text-lg font-semibold text-gray-800">Nákup z ${list.date}</span>
                        <span class="text-sm font-bold text-emerald-600">€${list.total.toFixed(2)}</span>
                    </div>
                    <ul class="list-disc list-inside mt-2 text-gray-700 text-sm">
                        ${list.items.map(item => `
                            <li class="${item.completed ? 'line-through text-gray-500' : ''}">
                                ${item.text} ${item.price ? `(${parseFloat(item.price).toFixed(2)} €)` : ''}
                            </li>
                        `).join('')}
                    </ul>
                    ${receiptImageHtml}
                    ${list.receiptNotes ? `<p class="mt-2 text-sm text-gray-600 border-t pt-2 border-gray-200"><strong>Poznámka k bločku:</strong><br>${list.receiptNotes}</p>` : ''}
                    <div class="flex justify-end mt-4 no-print">
                        <button onclick="printList(${index})" class="bg-indigo-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-indigo-600 transition duration-200">Tlačiť</button>
                        <button onclick="deleteSavedList(${index})" class="ml-2 bg-rose-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-rose-600 transition duration-200">Vymazať</button>
                    </div>
                `;
                savedListsContainer.appendChild(listItem);
            });
        }
        
        /**
         * Prepína zobrazenie medzi aktuálnym zoznamom a históriou.
         */
        function toggleView(view) {
            if (view === 'current') {
                currentListSection.classList.remove('hidden');
                historySection.classList.add('hidden');
                showCurrentListBtn.classList.add('bg-emerald-500', 'text-white');
                showCurrentListBtn.classList.remove('bg-slate-200', 'text-gray-700');
                showHistoryBtn.classList.remove('bg-emerald-500', 'text-white');
                showHistoryBtn.classList.add('bg-slate-200', 'text-gray-700');
            } else if (view === 'history') {
                currentListSection.classList.add('hidden');
                historySection.classList.remove('hidden');
                showHistoryBtn.classList.add('bg-emerald-500', 'text-white');
                showHistoryBtn.classList.remove('bg-slate-200', 'text-gray-700');
                showCurrentListBtn.classList.remove('bg-emerald-500', 'text-white');
                showCurrentListBtn.classList.add('bg-slate-200', 'text-gray-700');
                renderHistory();
            }
        }

        /**
         * Pridá novú položku do zoznamu.
         */
        function addItem(text) {
            if (text.trim() === '') return;
            currentItems.push({ text: text.trim(), completed: false, price: null });
            itemInput.value = '';
            saveData();
            renderCurrentList();
        }

        /**
         * Upraví cenu položky pomocou modálneho okna.
         */
        function showPriceModal(index) {
            itemIndexToEdit = index;
            // Nastaví hodnotu poľa na existujúcu cenu (ak existuje)
            modalPriceInput.value = currentItems[index].price !== null ? currentItems[index].price : '';
            priceError.classList.add('hidden'); // Skryje chybovú hlášku pri otvorení
            priceModal.classList.remove('hidden');
        }

        /**
         * Bezpečná funkcia na vyhodnotenie matematického výrazu.
         * Kontroluje, či výraz obsahuje len povolené znaky, čím sa predchádza nebezpečnému kódu.
         */
        function evaluateMathExpression(expression) {
            // Povolené znaky: čísla, bodka, medzery a operátory +, -, *, /
            const sanitizedExpression = expression.replace(/,/g, '.'); // Nahradi čiarky bodkami
            if (/^[0-9\s.+-/*()]+$/.test(sanitizedExpression)) {
                try {
                    // Použitie Function() je bezpečnejšie ako eval()
                    return new Function('return ' + sanitizedExpression)();
                } catch (e) {
                    return NaN; // Vráti NaN pri chybe výpočtu
                }
            }
            return NaN; // Vráti NaN ak sú vo výraze nepovolené znaky
        }


        /**
         * Uloží cenu z modálneho okna.
         */
        function savePrice() {
            if (itemIndexToEdit !== null) {
                const expression = modalPriceInput.value.trim();
                const newPrice = evaluateMathExpression(expression);

                if (isNaN(newPrice)) {
                    priceError.classList.remove('hidden');
                    return;
                }
                
                currentItems[itemIndexToEdit].price = newPrice;
                saveData();
                renderCurrentList();
                hidePriceModal();
            }
        }

        /**
         * Skryje modálne okno pre cenu.
         */
        function hidePriceModal() {
            priceModal.classList.add('hidden');
            itemIndexToEdit = null;
        }
        
        /**
         * Zobrazí modálne okno s detailmi bločku.
         */
        function showReceiptModal() {
            if (currentItems.length === 0) {
                 const modal = document.createElement('div');
                 modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4";
                 modal.innerHTML = `
                      <div class="bg-white p-6 rounded-lg shadow-xl text-center">
                          <p class="text-lg font-semibold text-gray-800 mb-4">Zoznam je prázdny. Nemôžete uložiť prázdny zoznam.</p>
                          <button class="bg-emerald-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-emerald-600 transition duration-200" onclick="this.parentElement.parentElement.remove()">Zavrieť</button>
                      </div>
                 `;
                 document.body.appendChild(modal);
                 return;
             }
            receiptModal.classList.remove('hidden');
        }

        /**
         * Prepne stav 'dokončené' pre položku.
         */
        function toggleItemCompleted(index) {
            if (index >= 0 && index < currentItems.length) {
                currentItems[index].completed = !currentItems[index].completed;
                const itemToMove = currentItems.splice(index, 1)[0];
                if (itemToMove.completed) {
                    currentItems.push(itemToMove);
                } else {
                    currentItems.unshift(itemToMove);
                }
                saveData();
                renderCurrentList();
            }
        }

        /**
         * Vymaže konkrétnu položku.
         */
        function deleteItem(index) {
            if (index >= 0 && index < currentItems.length) {
                currentItems.splice(index, 1);
                saveData();
                renderCurrentList();
            }
        }

        /**
         * Vymaže všetky dokončené položky.
         */
        function clearCompleted() {
            currentItems = currentItems.filter(item => !item.completed);
            saveData();
            renderCurrentList();
        }

        /**
         * Vymaže všetky položky.
         */
        function clearAll() {
            currentItems = [];
            saveData();
            renderCurrentList();
        }

        /**
         * Uloží aktuálny zoznam do histórie.
         */
        function saveList() {
            const receiptNotes = receiptNotesInput.value || null;
            const total = currentItems.reduce((sum, item) => sum + (item.price || 0), 0);
            savedHistory.unshift({
                date: new Date().toLocaleDateString('sk-SK'),
                total: total,
                receiptNotes: receiptNotes,
                receiptImage: receiptImageBase64,
                items: currentItems
            });
            currentItems = [];
            receiptImageBase64 = null;
            receiptNotesInput.value = '';
            receiptImageInput.value = '';
            saveData();
            renderCurrentList();
            toggleView('history');
            receiptModal.classList.add('hidden');
        }

        /**
         * Vymaže uložený zoznam z histórie.
         */
        function deleteSavedList(index) {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4";
            
            const modalContent = document.createElement('div');
            modalContent.className = "bg-white p-6 rounded-lg shadow-xl text-center";
            modalContent.innerHTML = `
                <p class="text-lg font-semibold text-gray-800 mb-4">Naozaj chcete vymazať tento nákup?</p>
                <div class="flex justify-center gap-2">
                     <button id="confirmDeleteBtn" class="bg-rose-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-rose-600 transition duration-200">Áno</button>
                     <button id="cancelDeleteBtn" class="bg-slate-200 text-gray-700 py-2 px-4 rounded-xl font-semibold hover:bg-slate-300 transition duration-200">Nie</button>
                </div>
            `;
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            // Pridanie event listenerov po vytvorení elementov
            document.getElementById('confirmDeleteBtn').addEventListener('click', () => {
                confirmDelete(index);
                modal.remove();
            });

            document.getElementById('cancelDeleteBtn').addEventListener('click', () => {
                modal.remove();
            });
        }

        /**
         * Potvrdí a vymaže uložený zoznam.
         */
        window.confirmDelete = (index) => {
            savedHistory.splice(index, 1);
            saveData();
            renderHistory();
        };

        /**
         * Vytlačí uložený zoznam.
         */
        function printList(index) {
            const listToPrint = savedHistory[index];
            
            let receiptImageHtml = '';
            if (listToPrint.receiptImage) {
                receiptImageHtml = `<div class="mt-6 receipt-image-print"><h2 class="text-2xl font-bold text-gray-800 mb-4">Obrázok bločku</h2><img src="${listToPrint.receiptImage}" alt="Obrázok bločku" style="max-width: 100%; height: auto; border: 1px solid #e5e7eb; border-radius: 0.5rem;"></div>`;
            }

            const printContent = `
                <div class="p-8">
                    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Nákupný Zoznam</h1>
                    <p class="text-center text-gray-600 mb-4"><strong>Dátum:</strong> ${listToPrint.date}</p>
                    <ul class="space-y-2">
                        ${listToPrint.items.map(item => `
                            <li class="flex justify-between items-center text-lg">
                                <span class="${item.completed ? 'line-through text-gray-500' : ''}">${item.text}</span>
                                <span class="font-semibold text-gray-800">${item.price ? `€${parseFloat(item.price).toFixed(2)}` : ''}</span>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="mt-6 text-right font-bold text-2xl text-gray-800 border-t pt-4">
                        Celková suma: €${listToPrint.total.toFixed(2)}
                    </div>
                    ${receiptImageHtml}
                    ${listToPrint.receiptNotes ? `<div class="mt-6 border-t pt-4"><p class="text-sm"><strong>Poznámka k bločku:</strong><br>${listToPrint.receiptNotes}</p></div>` : ''}
                    <div class="no-print mt-6 text-center">
                        <button onclick="window.close()" class="bg-indigo-500 text-white py-2 px-4 rounded-xl font-semibold hover:bg-indigo-600 transition duration-200">Späť do aplikácie</button>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '', 'width=800,height=600');
            printWindow.document.write('<html><head><title>Tlač nákupu</title>');
            printWindow.document.write('<style>@import url(\'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap\');body{font-family:\'Inter\',sans-serif;}</style>');
            printWindow.document.write('<style>@media print { .no-print { display: none; } }</style>');
            printWindow.document.write('</head><body>');
            printWindow.document.write(printContent);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.onafterprint = () => printWindow.close();
            }, 500);
        }

        /**
         * Pridá drag-and-drop event listenery pre všetky položky zoznamu.
         */
        function addDragAndDropListeners() {
            const listItems = document.querySelectorAll('#shoppingList li');
            listItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('dragleave', handleDragLeave);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragend', handleDragEnd);
            });
        }

        // --- Drag and Drop funkcie ---
        function handleDragStart(e) {
            dragSrcEl = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            this.classList.add('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('bg-gray-200');
        }

        function handleDragLeave(e) {
            this.classList.remove('bg-gray-200');
        }

        function handleDrop(e) {
            e.stopPropagation();
            if (dragSrcEl !== this) {
                const dragIndex = parseInt(dragSrcEl.getAttribute('data-index'));
                const dropIndex = parseInt(this.getAttribute('data-index'));
                
                const [removed] = currentItems.splice(dragIndex, 1);
                currentItems.splice(dropIndex, 0, removed);
                
                saveData();
                renderCurrentList();
            }
            return false;
        }

        function handleDragEnd(e) {
            const listItems = document.querySelectorAll('#shoppingList li');
            listItems.forEach(item => {
                item.classList.remove('dragging', 'bg-gray-200');
            });
        }
        
        // Nastavenie všetkých event listenerov
        function setupEventListeners() {
            addItemForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addItem(itemInput.value);
            });
            clearCompletedBtn.addEventListener('click', clearCompleted);
            clearAllBtn.addEventListener('click', clearAll);
            saveListBtn.addEventListener('click', showReceiptModal);
            confirmSaveListBtn.addEventListener('click', saveList);
            cancelSaveListBtn.addEventListener('click', () => {
                receiptModal.classList.add('hidden');
            });

            receiptImageInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        receiptImageBase64 = reader.result;
                    };
                    reader.readAsDataURL(file);
                }
            });

            showCurrentListBtn.addEventListener('click', () => toggleView('current'));
            showHistoryBtn.addEventListener('click', () => toggleView('history'));

            // Event listenery pre nový modal s cenou
            savePriceBtn.addEventListener('click', savePrice);
            cancelPriceBtn.addEventListener('click', hidePriceModal);
        }

        // Inicializácia pri načítaní stránky
        window.addEventListener('load', () => {
            loadData();
            renderCurrentList();
            setupEventListeners();
        });

        // Sprístupnenie funkcií pre globálny scope, ak sú použité v HTML (napr. onclick)
        window.deleteSavedList = deleteSavedList;
        window.printList = printList;
    </script>
</body>
</html>
